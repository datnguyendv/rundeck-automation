- defaultTab: nodes
  description: |-
    Server disk diagnostics.

    This job checks the disk status on a remote system. And tries to free some space if the disk is full.
  executionEnabled: true
  group: Use Cases/Incident Response Examples/Web Service
  id: 615088a8-9e63-489f-858a-2749638b135c
  loglevel: INFO
  name: Disk Diagnostics
  nodeFilterEditable: false
  nodefilters:
    dispatch:
      excludePrecedence: true
      keepgoing: false
      rankOrder: ascending
      successOnEmptyNodeFilter: false
      threadcount: '1'
    filter: 'name: ${option.filter}'
  nodesSelectedByDefault: true
  options:
  - label: Node filter
    name: filter
    value: node1
  - label: Critical disk usage (percent)
    name: critical_value
    value: '99'
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: Friendly starting message
      exec: echo "Starting disk diagnostics..."
    - description: Get the Disk Usage
      fileExtension: .sh
      interpreterArgsQuoted: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            regex: ^(disk_usage)=*(.+)$
          type: key-value-data
      script: |-
        ###################################################################
        # 1. disk usage
        ###################################################################
        echo "disk_usage=$(df --output=pcent / | tr -dc '0-9')"

        # time to check the output
        sleep 5
      scriptInterpreter: /bin/bash
    - description: Evaluate and take actions
      fileExtension: .sh
      interpreterArgsQuoted: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            regex: ^(disk_status)=*(.+)$
          type: key-value-data
      script: |-
        ###################################################################
        # 1. evaluates the disk usage
        ###################################################################
        if (( @data.disk_usage@ >= @option.critical_value@ )); then
            echo "disk_status=full"
        else
            echo "disk_status=ok"
        fi


        # time to check the output
        sleep 5
      scriptInterpreter: /bin/bash
    - description: Notify in case of reach a critical value
      fileExtension: .sh
      interpreterArgsQuoted: false
      script: "###################################################################\n\
        # 1. actions\n###################################################################\n\
        \nif [ \"@data.disk_status@\" = \"ok\" ]; then\n    echo \"All ok!\"\nelse\n\
        \    echo \"Disk full!\"\n    echo \"Clean up APT cache...\"\n    sudo du\
        \ -sh /var/cache/apt \n    echo \"Removing outdates packages...\"\n    sudo\
        \ apt-get autoclean\nfi"
      scriptInterpreter: /bin/bash
    keepgoing: false
    strategy: node-first
  uuid: 615088a8-9e63-489f-858a-2749638b135c

